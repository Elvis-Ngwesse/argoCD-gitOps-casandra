apiVersion: batch/v1
kind: Job
metadata:
  name: python-test-job
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    metadata: {}              # << Add this line
    spec:
      restartPolicy: Never
      volumes:
        - name: app-code
          emptyDir: {}

      initContainers:
        - name: git-clone
          image: alpine/git
          command:
            - sh
            - -c
            - git clone https://github.com/Elvis-Ngwesse/argoCD-mongodb.git /app
          volumeMounts:
            - name: app-code
              mountPath: /app

      containers:
        - name: pytest
          image: python:3.10
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: minio-creds
                  key: accesskey
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-creds
                  key: secretkey
            - name: MINIO_ENDPOINT
              value: "http://minio-service:9000"
            - name: MINIO_BUCKET
              value: "test-reports"
          command:
            - sh
            - -c
            - |
              pip install -r unit-tests/requirements.txt boto3 pytest-html && \
              export PYTHONPATH=/app && \
              timestamp=$(date +%Y%m%d%H%M%S) && \
              pytest unit-tests/test_app.py --junitxml=results_$timestamp.xml --html=results_$timestamp.html && \
              python3 /app/unit-tests/upload_results.py
          workingDir: /app
          volumeMounts:
            - name: app-code
              mountPath: /app
