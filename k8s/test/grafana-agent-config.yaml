apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-agent-config
  namespace: logging
  annotations:
    argocd.argoproj.io/sync-wave: "5"
data:
  agent.yaml: |
    server:
      log_level: info
      http_listen_address: 0.0.0.0
      http_listen_port: 12345

    prometheus:
      wal_directory: /tmp/grafana-agent-wal
      global:
        scrape_interval: 15s
        scrape_timeout: 10s
      configs:
        - name: default
          scrape_configs:
            - job_name: node
              static_configs:
                - targets: ['localhost:9100']
              metrics_path: /metrics
              scheme: http

    integrations:
      node_exporter:
        enabled: true
        procfs: /host/proc
        sysfs: /host/sys
        cgroups: /host/sys/fs/cgroup

    logs:
      configs:
        - name: varlogs
          positions:
            filename: /tmp/positions.yaml
          clients:
            - url: http://loki.logging.svc.cluster.local:3100/loki/api/v1/push
          scrape_configs:
            - job_name: varlogs
              static_configs:
                - targets:
                    - localhost
                  labels:
                    job: varlogs
                    __path__: /var/log/**/*.log
