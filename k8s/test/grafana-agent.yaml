apiVersion: monitoring.grafana.com/v1alpha1
kind: GrafanaAgent
metadata:
  name: grafana-agent
  namespace: logging
  annotations:
    argocd.argoproj.io/sync-wave: "5"
spec:
  image: grafana/agent:v0.44.3
  serviceAccountName: grafana-agent
  logLevel: info
  metrics:
    instanceSelector:
      matchLabels:
        agent: grafana-agent-metrics
    externalLabels:
      cluster: minikube
  logs:
    instanceSelector:
      matchLabels:
        agent: grafana-agent-logs
---
apiVersion: monitoring.grafana.com/v1alpha1
kind: GrafanaAgentMetrics
metadata:
  name: grafana-agent-metrics
  namespace: logging
  annotations:
    argocd.argoproj.io/sync-wave: "5"
  labels:
    agent: grafana-agent-metrics
spec:
  scrapeConfigs:
    - job_name: kubernetes-pods
      kubernetes_sd_configs:
        - role: pod
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: true
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          action: replace
          target_label: __metrics_path__
          regex: (.+)
        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          target_label: __address__
  remoteWrite:
    - url: http://prometheus.logging.svc.cluster.local:9090/api/v1/write
---
apiVersion: monitoring.grafana.com/v1alpha1
kind: GrafanaAgentLogs
metadata:
  name: grafana-agent-logs
  namespace: logging
  annotations:
    argocd.argoproj.io/sync-wave: "5"
  labels:
    agent: grafana-agent-logs
spec:
  clients:
    - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push
  positions:
    filename: /tmp/positions.yaml
  scrapeConfigs:
    - job_name: kubernetes-pods-logs
      kubernetes_sd_configs:
        - role: pod
      pipelineStages:
        - docker: {}
      relabelConfigs:
        - sourceLabels: [__meta_kubernetes_pod_label_app]
          targetLabel: job
